"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.CN_CHAR_REGEX = void 0;
const pinyin_pro_1 = require("pinyin-pro");
const child_process_1 = require("child_process");
const fs_1 = __importDefault(require("fs"));
const SPLIT_TOKEN = 'âœ©';
exports.CN_CHAR_REGEX = /[\u4E00-\u9FA5]|[\uFE30-\uFFA0]/gi;
const pathUtils = {
    replaceSpace: (path) => path.replace(/\s/g, '%20'),
    replaceRelativeHomePath: (path) => path.replace('~', process.env.HOME),
    process: (path) => pathUtils.replaceRelativeHomePath(pathUtils.replaceSpace(path)),
};
const utils = {
    /**
     * æ ¹æ®paramsåˆ—å‡ºçš„å±æ€§è¿›è¡Œè¿‡æ»¤ï¼Œä¸åŒºåˆ†å¤§å°å†™
     * å¦‚æœæŸ¥è¯¢å…³é”®è¯ä¸ºç©ºï¼Œè¿”å›åŸæ•°ç»„
     * @param items
     * @param query
     * @param params
     * @param noResultsItem å¦‚æœè¿‡æ»¤å®Œæ²¡æœ‰ç»“æœåˆ™æ˜¾ç¤ºè¯¥æ¡ç›®
     * @return {ScriptFilterItem[]}
     */
    filterItemsBy: (items, query = '', params, noResultsItem) => {
        query = query.trim();
        if (query) {
            let filterItems = items.filter((item) => {
                // å¯¹äºæ²¡æœ‰è¯¥å‚æ•°å±æ€§çš„ï¼Œè¿”å›trueï¼Œé€šè¿‡
                return params.some((p) => {
                    var _a;
                    if (item[p] === undefined) {
                        return;
                    }
                    if (((_a = item[p]) === null || _a === void 0 ? void 0 : _a.match(exports.CN_CHAR_REGEX)) && !query.match(exports.CN_CHAR_REGEX)) {
                        return pinyin_pro_1.pinyin(item[p], {
                            toneType: 'none',
                            nonZh: 'consecutive',
                        }).replace(/\s/g, '').match(new RegExp(query, 'i'));
                    }
                    return item[p].match(new RegExp(query, 'i'));
                });
            });
            if (filterItems.length === 0 && noResultsItem) {
                return [noResultsItem];
            }
            return filterItems;
        }
        else {
            return items;
        }
    },
    /**
     * æ„å»ºå•ä¸ªé¡¹
     * @param item
     */
    buildItem: (item) => item,
    /**
     * è·¯å¾„ä¸­ç©ºæ ¼åŠ è½¬ä¹‰å­—ç¬¦
     * @param filepath
     */
    escapeFilePath: (filepath) => pathUtils.replaceRelativeHomePath(filepath).replace(/(\s)/, '\\$1'),
    quickLookUrl4File: (filename) => `file://${pathUtils.replaceSpace(filename)}`,
    /**
     * è¾“å‡ºåˆ—è¡¨
     * @param sf
     */
    printScriptFilter: (sf) => {
        console.log(JSON.stringify(sf));
    },
    /**
     * Script item argä¸ºå­—ç¬¦ä¸²ï¼Œæœ‰æ—¶éœ€è¦å¤šä¸ªå‚æ•°ä¼ é€’ï¼Œå¯ä»¥ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥
     * @param args
     * @return {string}
     */
    joinMultiArg: (...args) => args.join(SPLIT_TOKEN),
    /**
     *
     * @param argStr
     * @return {string[]}
     */
    splitMultiArgStr: (argStr) => argStr.split(SPLIT_TOKEN),
    /**
     * Macè‡ªå¸¦emojiè¡¨æƒ…æ”¯æŒ
     * @see https://support.apple.com/zh-cn/guide/mac-help/mchlp1560/mac
     */
    emoji: {
        checked: 'â˜‘ï¸',
        unchecked: 'âœ–ï¸',
        locked: 'ğŸ”’',
        greenChecked: 'âœ…',
        greenUnChecked: 'â'
    },
    /**
     * è®¾ç½®å½“å‰workflowç¯å¢ƒå˜é‡
     * @param key
     * @param value
     */
    setVariable: (key, value) => {
        child_process_1.execSync(`osascript -e 'tell application id "com.runningwithcrayons.Alfred" to set configuration "${key}" to value "${String(value)}" in workflow "${process.env.alfred_workflow_bundleid}"'`);
    },
    /**
     * åˆ é™¤å½“å‰workflowç¯å¢ƒå˜é‡
     * @param key
     */
    removeVariable: (key) => {
        child_process_1.execSync(`osascript -e 'tell application id "com.runningwithcrayons.Alfred" to remove configuration "${key}" in workflow "${process.env.alfred_workflow_bundleid}"'`);
    },
    /**
     * æ‹·è´åˆ°ç³»ç»Ÿå‰ªè´´æ¿
     */
    copyToClipboard(thePath) {
        thePath = pathUtils.replaceSpace(thePath);
        child_process_1.execSync(`osascript -e 'set the clipboard to POSIX file "${thePath}"\n delay 1'`);
    },
    /**
     * å‰ªè´´æ¿å›¾ç‰‡å¦å­˜åˆ°æŸä½ç½®
     * @param filePath
     */
    writeToPicFileFromClipboard(filePath) {
        filePath = pathUtils.process(filePath);
        child_process_1.execSync(`osascript -e 'try
  set imageData to the clipboard as {Â«class PNGfÂ»}
on error
  tell me to error "Clipboard data does not seem to be an image"
end try

set filePath to "${filePath}"
try
set imageFile to open for access filePath with write permission
write imageData to imageFile
close access imageFile
on error
try
        close access myFile
    end try
end try
'`);
    },
    formatBytes(bytes, decimals = 2) {
        if (bytes === 0)
            return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    },
    /**
     * åˆ›å»ºç¼“å­˜æ–‡ä»¶å¤¹
     */
    useCache() {
        child_process_1.execSync(`[[ -d "${process.env.alfred_workflow_cache}" ]] || mkdir "${process.env.alfred_workflow_cache}"`);
    },
    writeCacheData(key, maxAge, data) {
        return new Promise(resolve => {
            fs_1.default.writeFile(`${process.env.alfred_workflow_cache}/${key}.cache`, JSON.stringify({
                maxAge: Date.now() + maxAge,
                data,
            }), resolve);
        });
    },
    readCacheData(key) {
        return new Promise(resolve => {
            fs_1.default.readFile(`${process.env.alfred_workflow_cache}/${key}.cache`, { encoding: 'utf8' }, (err, res) => {
                if (err) {
                    resolve(null);
                    return;
                }
                const data = JSON.parse(res);
                if (data.maxAge < Date.now()) {
                    resolve(null);
                }
                else {
                    resolve(data.data);
                }
            });
        });
    },
    /**
     * ä¸æ·»åŠ æ–°è¡Œæ‰“å°
     * @param options
     */
    log(...options) {
        process.stdout.write(...options);
    },
};
exports.default = utils;
